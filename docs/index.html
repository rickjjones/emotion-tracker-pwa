<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>LifeLens</title>
    <meta name="theme-color" content="#4CAF50">
    <link rel="manifest" href="manifest.json"> <!-- removed leading slash -->
    <link rel="icon" href="icon-192x192.svg">    <!-- removed leading slash -->
</head>
<body>
    <div class="container">
        <div class="topbar">
            <h1>LifeLense</h1>
            <button id="theme-toggle" aria-label="Toggle dark mode" title="Toggle dark mode">ðŸŒ™</button>
        </div>

        <!-- Categories editor modal -->
        <div id="categories-edit-modal" class="modal" hidden aria-hidden="true">
            <div class="modal__backdrop" id="categories-edit-backdrop"></div>
            <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="categories-edit-title">
                <h2 id="categories-edit-title">Edit categories and emotions</h2>
                <div id="categories-edit-list"></div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <button id="add-category" type="button">Add Category</button>
                    <button id="reset-categories" type="button">Reset to defaults</button>
                    <button id="export-categories" type="button">Export config</button>
                    <button id="import-categories" type="button">Import config</button>
                    <input type="file" id="import-categories-file" accept="application/json" style="display:none">
                </div>
                <div style="margin-top:12px;text-align:right;">
                    <button id="categories-edit-cancel" type="button">Cancel</button>
                    <button id="categories-edit-save" type="button">Save</button>
                </div>
            </div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
            <button id="customize-emotions" title="Customize which emotions to track">Customize Emotions</button>
            <button id="edit-categories" title="Edit categories and emotion labels">Edit Categories</button>
            <span style="color:#666;font-size:0.9rem;">Select which emotions appear on the form or edit categories</span>
        </div>

        <!-- The form is rendered dynamically by app.js based on selected categories/emotions -->
        <form id="emotion-form"></form>

        <!-- Categories / emotion selection modal -->
        <div id="categories-modal" class="modal" hidden aria-hidden="true">
            <div class="modal__backdrop" id="categories-backdrop"></div>
            <div class="modal__panel" role="dialog" aria-modal="modal__panel" aria-labelledby="categories-title">
                <h2 id="categories-title">Choose emotions to track</h2>
                <div id="categories-list"></div>
                <div style="margin-top:12px;text-align:right;">
                    <button id="categories-cancel" type="button">Cancel</button>
                    <button id="categories-save" type="button">Save</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="view-history">View History</button>
            <button id="export-json">Export JSON</button>
            <button id="export-csv">Export CSV</button>
            <button id="export-unsynced">Export Unsynced</button>
            <button id="undo-last-export">Undo Last Export</button>
            <button id="import-json">Import JSON</button>
            <button id="clear-all">Clear All</button>
            <input type="file" id="import-file" accept="application/json" style="display:none">
        </div>
        <div style="text-align:center;margin-top:8px;color:#666;font-size:0.9rem;">
            <span style="display:inline-block;margin-right:8px">â€¢ <strong>Exported</strong> entries are marked in history</span>
        </div>

        <div id="emotion-display"></div>
    </div>
    <script src="app.js"></script>

        <script>
                // Improved service worker registration with fetch check and detailed logging.

                // helper: show a small update bar with a reload button and 10s auto-reload
                function showUpdateBanner(worker) {
                    try {
                        const existing = document.getElementById('sw-update');
                        if (existing) return; // already shown

                        const bar = document.createElement('div');
                        bar.id = 'sw-update';
                        bar.className = 'sw-update';

                        const msg = document.createElement('div');
                        msg.className = 'sw-update__msg';
                        msg.textContent = 'A new version is available. Reloading in 10s...';

                        const actions = document.createElement('div');

                        const reloadBtn = document.createElement('button');
                        reloadBtn.className = 'sw-update__btn';
                        reloadBtn.textContent = 'Reload now';
                        reloadBtn.addEventListener('click', () => {
                            try { worker.postMessage({ type: 'SKIP_WAITING' }); } catch (e) { console.error(e); }
                        });

                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'sw-update__btn';
                        cancelBtn.style.background = '#999';
                        cancelBtn.textContent = 'Cancel';
                        cancelBtn.addEventListener('click', () => {
                            clearInterval(countdown);
                            bar.remove();
                        });

                        actions.appendChild(reloadBtn);
                        actions.appendChild(cancelBtn);

                        bar.appendChild(msg);
                        bar.appendChild(actions);
                        document.body.appendChild(bar);

                        let seconds = 10;
                        const countdown = setInterval(() => {
                            seconds -= 1;
                            msg.textContent = `A new version is available. Reloading in ${seconds}s...`;
                            if (seconds <= 0) {
                                clearInterval(countdown);
                                try { worker.postMessage({ type: 'SKIP_WAITING' }); } catch (e) { console.error(e); }
                            }
                        }, 1000);

                        // Attempt to reload when the worker activates
                        try {
                          worker.addEventListener('statechange', () => {
                            if (worker.state === 'activated') window.location.reload();
                          });
                        } catch (e) { /* ignore */ }

                    } catch (e) { console.error(e); }
                }

                if ('serviceWorker' in navigator) {
            // Try fetching sw.js first to get clearer errors (404 or wrong MIME type)
            fetch('sw.js', { cache: 'no-store' }).then(resp => {
                if (!resp.ok) throw new Error('sw.js fetch failed: ' + resp.status + ' ' + resp.statusText);
                return navigator.serviceWorker.register('sw.js', { scope: './' });
            }).then(reg => {
                console.log('Service worker registered:', reg);
                // If there's an already-waiting worker (from a previous update), prompt user
                if (reg.waiting) {
                    showUpdateBanner(reg.waiting);
                }
                reg.addEventListener('updatefound', () => {
                    const installing = reg.installing;
                    installing.addEventListener('statechange', () => {
                        if (installing.state === 'installed' && navigator.serviceWorker.controller) {
                            // new update available
                            showUpdateBanner(installing);
                        }
                    });
                });
            }).catch(err => {
                console.error('Service worker registration failed:', err);
                // Show a small notice in the page to help debugging on mobile devices
                try {
                    const el = document.createElement('div');
                    el.textContent = 'Service Worker failed: ' + (err && err.message ? err.message : String(err));
                    el.style.position = 'fixed';
                    el.style.left = '12px';
                    el.style.bottom = '12px';
                    el.style.background = '#c0392b';
                    el.style.color = '#fff';
                    el.style.padding = '8px 10px';
                    el.style.borderRadius = '6px';
                    document.body.appendChild(el);
                    setTimeout(() => el.remove(), 8000);
                } catch (e) {
                    // ignore
                        }
                        // helper: show a small update bar with a reload button
                        function showUpdateBanner(worker) {
                            // helper moved to top-level showUpdateBanner(worker)
                        }
            });
        }
                // Listen for messages from the service worker (e.g., SW_UPDATED)
                navigator.serviceWorker && navigator.serviceWorker.addEventListener && navigator.serviceWorker.addEventListener('message', (e) => {
                    if (e.data && e.data.type === 'SW_UPDATED') {
                        // A new worker activated in the background â€” prompt reload
                        // Try to find a waiting worker to perform skipWaiting flow
                        if (navigator.serviceWorker.controller) {
                            // There is an active controller; show the banner so the user can reload
                            // We don't have a worker reference here, but reloading will pick up the latest.
                            showUpdateBanner({ postMessage: () => {} });
                        }
                    }
                });
        </script>
</body>
</html>