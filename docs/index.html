<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Emotion Tracker</title>
    <meta name="theme-color" content="#4CAF50">
    <link rel="manifest" href="manifest.json"> <!-- removed leading slash -->
    <link rel="icon" href="icon-192x192.svg">    <!-- removed leading slash -->
</head>
<body>
    <div class="container">
        <h1>Emotion Tracker</h1>
        <form id="emotion-form">
            <h2 class="category category--high">High Moods</h2>
            <div class="emotion">
                <label for="excitement">Excitement:</label>
                <input type="number" id="excitement" name="excitement" min="1" max="10">
            </div>
            <div class="emotion">
                <label for="talkative">Talkative:</label>
                <input type="number" id="talkative" name="talkative" min="1" max="10">
            </div>
            <div class="emotion">
                <label for="inflated_self_confidence">Inflated self confidence:</label>
                <input type="number" id="inflated_self_confidence" name="inflated_self_confidence" min="1" max="10">
            </div>
            <div class="emotion">
                <label for="sleep_high">Sleep (quality/amount):</label>
                <input type="number" id="sleep_high" name="sleep_high" min="1" max="10">
            </div>

            <h2 class="category category--low">Low Moods</h2>
            <div class="emotion">
                <label for="energy">Energy:</label>
                <input type="number" id="energy" name="energy" min="1" max="10">
            </div>
            <div class="emotion">
                <label for="unmotivated">Unmotivated:</label>
                <input type="number" id="unmotivated" name="unmotivated" min="1" max="10">
            </div>
            <div class="emotion">
                <label for="sleep_low">Sleep (low mood):</label>
                <input type="number" id="sleep_low" name="sleep_low" min="1" max="10">
            </div>
            <div class="emotion">
                <label for="guilt">Guilt:</label>
                <input type="number" id="guilt" name="guilt" min="1" max="10">
            </div>
            <div class="emotion">
                <label for="indecisive">Indecisive:</label>
                <input type="number" id="indecisive" name="indecisive" min="1" max="10">
            </div>
            <div class="emotion">
                <label for="crying">Crying:</label>
                <input type="number" id="crying" name="crying" min="1" max="10">
            </div>

            <h2 class="category category--adhd">ADHD</h2>
            <div class="emotion">
                <label for="impulsive">Impulsive:</label>
                <input type="number" id="impulsive" name="impulsive" min="1" max="10">
            </div>
            <div class="emotion">
                <label for="absent_minded">Absent minded:</label>
                <input type="number" id="absent_minded" name="absent_minded" min="1" max="10">
            </div>
            <div class="emotion">
                <label for="time_management">Time management:</label>
                <input type="number" id="time_management" name="time_management" min="1" max="10">
            </div>
            <div class="emotion">
                <label for="interrupting">Interrupting:</label>
                <input type="number" id="interrupting" name="interrupting" min="1" max="10">
            </div>
            <div class="emotion">
                <label for="overwhelmed">Overwhelmed:</label>
                <input type="number" id="overwhelmed" name="overwhelmed" min="1" max="10">
            </div>

            <div class="emotion note-row">
                <label for="note">Note:</label>
                <textarea id="note" name="note" class="note-field" placeholder="Add a note..." rows="3"></textarea>
            </div>
            <button type="submit">Save Emotions</button>
        </form>

        <div class="controls">
            <button id="menu-toggle" aria-expanded="false" aria-controls="menu-flyout" title="Open menu">☰ Menu</button>
            <div id="menu-flyout" class="menu-flyout">
                <div class="menu-row"><button id="view-history">View History</button></div>
                <div class="menu-row"><button id="export-json">Export JSON</button></div>
                <div class="menu-row"><button id="export-csv">Export CSV</button></div>
                <div class="menu-row"><button id="export-unsynced">Export Unsynced</button></div>
                <div class="menu-row"><button id="undo-last-export">Undo Last Export</button></div>
                <div class="menu-row"><button id="import-json">Import JSON</button></div>
                <div class="menu-row"><button id="clear-all">Clear All</button></div>
                <input type="file" id="import-file" accept="application/json" style="display:none">
            </div>
        </div>
        <div class="menu-legend">• <strong>Exported</strong> entries are marked in history</div>

        <div id="emotion-display"></div>
    </div>
    <script src="app.js"></script>

        <script>
                // Improved service worker registration with fetch check and detailed logging.

                // helper: show a small update bar with a reload button and 10s auto-reload
                function showUpdateBanner(worker) {
                    try {
                        const existing = document.getElementById('sw-update');
                        if (existing) return; // already shown

                        const bar = document.createElement('div');
                        bar.id = 'sw-update';
                        bar.className = 'sw-update';

                        const msg = document.createElement('div');
                        msg.className = 'sw-update__msg';
                        msg.textContent = 'A new version is available. Reloading in 10s...';

                        const actions = document.createElement('div');

                        const reloadBtn = document.createElement('button');
                        reloadBtn.className = 'sw-update__btn';
                        reloadBtn.textContent = 'Reload now';
                        reloadBtn.addEventListener('click', () => {
                            try { worker.postMessage({ type: 'SKIP_WAITING' }); } catch (e) { console.error(e); }
                        });

                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'sw-update__btn';
                        cancelBtn.style.background = '#999';
                        cancelBtn.textContent = 'Cancel';
                        cancelBtn.addEventListener('click', () => {
                            clearInterval(countdown);
                            bar.remove();
                        });

                        actions.appendChild(reloadBtn);
                        actions.appendChild(cancelBtn);

                        bar.appendChild(msg);
                        bar.appendChild(actions);
                        document.body.appendChild(bar);

                        let seconds = 10;
                        const countdown = setInterval(() => {
                            seconds -= 1;
                            msg.textContent = `A new version is available. Reloading in ${seconds}s...`;
                            if (seconds <= 0) {
                                clearInterval(countdown);
                                try { worker.postMessage({ type: 'SKIP_WAITING' }); } catch (e) { console.error(e); }
                            }
                        }, 1000);

                        // Attempt to reload when the worker activates
                        try {
                          worker.addEventListener('statechange', () => {
                            if (worker.state === 'activated') window.location.reload();
                          });
                        } catch (e) { /* ignore */ }

                    } catch (e) { console.error(e); }
                }

                if ('serviceWorker' in navigator) {
            // Try fetching sw.js first to get clearer errors (404 or wrong MIME type)
            fetch('sw.js', { cache: 'no-store' }).then(resp => {
                if (!resp.ok) throw new Error('sw.js fetch failed: ' + resp.status + ' ' + resp.statusText);
                return navigator.serviceWorker.register('sw.js', { scope: './' });
            }).then(reg => {
                console.log('Service worker registered:', reg);
                // If there's an already-waiting worker (from a previous update), prompt user
                if (reg.waiting) {
                    showUpdateBanner(reg.waiting);
                }
                reg.addEventListener('updatefound', () => {
                    const installing = reg.installing;
                    installing.addEventListener('statechange', () => {
                        if (installing.state === 'installed' && navigator.serviceWorker.controller) {
                            // new update available
                            showUpdateBanner(installing);
                        }
                    });
                });
            }).catch(err => {
                console.error('Service worker registration failed:', err);
                // Show a small notice in the page to help debugging on mobile devices
                try {
                    const el = document.createElement('div');
                    el.textContent = 'Service Worker failed: ' + (err && err.message ? err.message : String(err));
                    el.style.position = 'fixed';
                    el.style.left = '12px';
                    el.style.bottom = '12px';
                    el.style.background = '#c0392b';
                    el.style.color = '#fff';
                    el.style.padding = '8px 10px';
                    el.style.borderRadius = '6px';
                    document.body.appendChild(el);
                    setTimeout(() => el.remove(), 8000);
                } catch (e) {
                    // ignore
                        }
                        // helper: show a small update bar with a reload button
                        function showUpdateBanner(worker) {
                            // helper moved to top-level showUpdateBanner(worker)
                        }
            });
        }
                // Listen for messages from the service worker (e.g., SW_UPDATED)
                navigator.serviceWorker && navigator.serviceWorker.addEventListener && navigator.serviceWorker.addEventListener('message', (e) => {
                    if (e.data && e.data.type === 'SW_UPDATED') {
                        // A new worker activated in the background — prompt reload
                        // Try to find a waiting worker to perform skipWaiting flow
                        if (navigator.serviceWorker.controller) {
                            // There is an active controller; show the banner so the user can reload
                            // We don't have a worker reference here, but reloading will pick up the latest.
                            showUpdateBanner({ postMessage: () => {} });
                        }
                    }
                });
        </script>
</body>
</html>